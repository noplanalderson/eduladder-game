<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduLadder Battle - By Ridwan Na'im</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tambahkan Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Custom styles untuk board */
    .board-cell {
      width: 48px;
      height: 48px;
      position: relative;
    }
    
    /* Styles untuk popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .popup-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* Animasi untuk token */
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .token-bounce {
      animation: bounce 1s ease-in-out infinite;
    }
    
    @media (max-width: 768px) {
      .board-cell {
        width: 32px;
        height: 32px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // Inisialisasi Lucide Icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    const { useState, useEffect, useRef } = React;
    
    // Fallback icons sederhana
    const PlayIcon = () => <span>‚ñ∂Ô∏è</span>;
    const UploadIcon = () => <span>üì§</span>;
    const DownloadIcon = () => <span>‚è¨</span>;
    const TimerIcon = () => <span>‚åõ</span>;
    const ChevronUpIcon = () => <span>üîº</span>;
    const ChevronDownIcon = () => <span>üîΩ</span>;

    const SnakesLaddersGame = () => {
      const [gameState, setGameState] = useState('setup');
      const [questions, setQuestions] = useState([]);
      const [ladderQuestions, setLadderQuestions] = useState([]);
      const [snakeQuestions, setSnakeQuestions] = useState([]);
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [currentTeam, setCurrentTeam] = useState('A');
      const [positions, setPositions] = useState({ A: 1, B: 1 });
      const [helps, setHelps] = useState({
        A: { throwQuestion: 2, clue: 1, shield: 1, changeQuestion: 1, doubleMove: 2 },
        B: { throwQuestion: 2, clue: 1, shield: 1, changeQuestion: 1, doubleMove: 2 }
      });
      const [selectedHelp, setSelectedHelp] = useState(null);
      const [showClue, setShowClue] = useState(false);
      const [shieldActive, setShieldActive] = useState(false);
      const [doubleMoveActive, setDoubleMoveActive] = useState(false);
      const [questionThrown, setQuestionThrown] = useState(false);
      const [gameTimer, setGameTimer] = useState(0);
      const [questionTimer, setQuestionTimer] = useState(0);
      const [showAnswer, setShowAnswer] = useState(false);
      const [ladderBonusQuestion, setLadderBonusQuestion] = useState(null);
      const [snakeSaveQuestion, setSnakeSaveQuestion] = useState(null);
      const [winner, setWinner] = useState(null);
      const [loading, setLoading] = useState(false);
      const [showWinnerPopup, setShowWinnerPopup] = useState(false);
      const [winnerReason, setWinnerReason] = useState('');
      const [uploadedFiles, setUploadedFiles] = useState({
        main: false,
        ladder: false,
        snake: false
      });
      const [specialQuestionAnswered, setSpecialQuestionAnswered] = useState(false);

      const gameTimerRef = useRef(null);
      const questionTimerRef = useRef(null);

      const snakes = {
        98: 28, 87: 24, 73: 51, 62: 19, 54: 34, 47: 26, 38: 15
      };
      
      const ladders = {
        4: 14, 9: 31, 21: 42, 28: 84, 51: 67, 71: 91, 80: 99
      };

      // Load data dari sessionStorage saat komponen mount
      useEffect(() => {
        const savedQuestions = sessionStorage.getItem('eduladder_questions');
        const savedLadderQuestions = sessionStorage.getItem('eduladder_ladder_questions');
        const savedSnakeQuestions = sessionStorage.getItem('eduladder_snake_questions');
        const savedUploadedFiles = sessionStorage.getItem('eduladder_uploaded_files');

        if (savedQuestions) {
          setQuestions(JSON.parse(savedQuestions));
        }
        if (savedLadderQuestions) {
          setLadderQuestions(JSON.parse(savedLadderQuestions));
        }
        if (savedSnakeQuestions) {
          setSnakeQuestions(JSON.parse(savedSnakeQuestions));
        }
        if (savedUploadedFiles) {
          setUploadedFiles(JSON.parse(savedUploadedFiles));
        }
      }, []);

      // Save data ke sessionStorage ketika ada perubahan
      useEffect(() => {
        sessionStorage.setItem('eduladder_questions', JSON.stringify(questions));
      }, [questions]);

      useEffect(() => {
        sessionStorage.setItem('eduladder_ladder_questions', JSON.stringify(ladderQuestions));
      }, [ladderQuestions]);

      useEffect(() => {
        sessionStorage.setItem('eduladder_snake_questions', JSON.stringify(snakeQuestions));
      }, [snakeQuestions]);

      useEffect(() => {
        sessionStorage.setItem('eduladder_uploaded_files', JSON.stringify(uploadedFiles));
      }, [uploadedFiles]);

      // Cleanup timers
      useEffect(() => {
        return () => {
          if (gameTimerRef.current) clearInterval(gameTimerRef.current);
          if (questionTimerRef.current) clearInterval(questionTimerRef.current);
        };
      }, []);

      useEffect(() => {
        if (gameState === 'playing') {
          gameTimerRef.current = setInterval(() => {
            setGameTimer(prev => prev + 1);
          }, 1000);
        } else {
          if (gameTimerRef.current) clearInterval(gameTimerRef.current);
        }
        
        return () => {
          if (gameTimerRef.current) clearInterval(gameTimerRef.current);
        };
      }, [gameState]);

      useEffect(() => {
        if (currentQuestion && questionTimer > 0) {
          questionTimerRef.current = setInterval(() => {
            setQuestionTimer(prev => {
              if (prev <= 1) {
                handleTimeout();
                return 0;
              }
              return prev - 1;
            });
          }, 1000);
        } else {
          if (questionTimerRef.current) clearInterval(questionTimerRef.current);
        }
        
        return () => {
          if (questionTimerRef.current) clearInterval(questionTimerRef.current);
        };
      }, [currentQuestion, questionTimer]);

      // Cek apakah soal sudah habis
      useEffect(() => {
        if (gameState === 'playing' && questions.length > 0) {
          const availableQuestions = questions.filter(q => !q.used);
          if (availableQuestions.length === 0) {
            endGameByQuestions();
          }
        }
      }, [questions, gameState]);

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const endGameByQuestions = () => {
        // Tentukan pemenang berdasarkan posisi tertinggi
        let winningTeam = null;
        let winnerPos = 0;
        
        if (positions.A > positions.B) {
          winningTeam = 'A';
          winnerPos = positions.A;
        } else if (positions.B > positions.A) {
          winningTeam = 'B';
          winnerPos = positions.B;
        } else {
          // Jika posisi sama, tentukan berdasarkan jumlah bantuan tersisa
          const totalHelpsA = Object.values(helps.A).reduce((a, b) => a + b, 0);
          const totalHelpsB = Object.values(helps.B).reduce((a, b) => a + b, 0);
          
          if (totalHelpsA > totalHelpsB) {
            winningTeam = 'A';
          } else if (totalHelpsB > totalHelpsA) {
            winningTeam = 'B';
          } else {
            winningTeam = 'Seri';
          }
        }
        
        setWinner(winningTeam);
        setWinnerReason(`Semua soal telah terjawab! Kelompok ${winningTeam} berada di posisi tertinggi (${winnerPos}).`);
        setShowWinnerPopup(true);
        
        if (gameTimerRef.current) clearInterval(gameTimerRef.current);
        if (questionTimerRef.current) clearInterval(questionTimerRef.current);
      };

      const endGameByPosition = (team) => {
        setWinner(team);
        setWinnerReason(`Kelompok ${team} berhasil mencapai kotak 100!`);
        setShowWinnerPopup(true);
        setGameState('finished');
      };

      const handleTimeout = () => {
        if (currentQuestion) {
          alert(`Waktu habis! Kelompok ${currentTeam} mundur ${currentQuestion.penalty} langkah.`);
          moveToken(currentTeam, -currentQuestion.penalty, true);
        }
      };

      const downloadTemplate = (type) => {
        let template, filename;
        
        if (type === 'main') {
          template = `Pertanyaan;Pilihan A;Pilihan B;Pilihan C;Pilihan D;Jawaban Benar (A/B/C/D);Clue;Reward (langkah maju);Penalty (langkah mundur);Durasi (detik)
Berapa hasil dari 2 + 2?;2;3;4;5;C;Operasi penjumlahan dasar;5;3;15
Apa ibu kota Indonesia?;Bandung;Jakarta;Surabaya;Medan;B;Kota terbesar di Indonesia;4;2;10
Siapa presiden pertama Indonesia?;Soeharto;Soekarno;Habibie;Megawati;B;Proklamator kemerdekaan;6;3;20
Berapa hasil dari 5 x 3?;10;15;20;25;B;Perkalian dasar;5;3;15
Planet terdekat dengan matahari?;Venus;Mars;Merkurius;Bumi;C;Planet pertama dari matahari;4;2;12
Berapa jumlah provinsi di Indonesia?;34;35;36;37;A;Jumlah provinsi saat ini;5;3;15
Siapa penemu lampu?;Edison;Einstein;Newton;Tesla;A;Penemu Amerika;5;3;15
1 + 1 = ?;1;2;3;4;B;Penjumlahan paling dasar;3;2;10
Ibu kota Jawa Barat?;Bandung;Jakarta;Semarang;Surabaya;A;Kota kembang;4;2;10
Hewan tercepat di darat?;Singa;Cheetah;Harimau;Kuda;B;Kucing besar berbintik;5;3;15`;
          filename = 'template_soal_utama.csv';
        } else if (type === 'ladder') {
          template = `Pertanyaan;Pilihan A;Pilihan B;Pilihan C;Pilihan D;Jawaban Benar (A/B/C/D);Clue
Berapa 8 + 7?;14;15;16;17;B;Penjumlahan dua angka
10 x 2 = ?;18;19;20;21;C;Perkalian dengan 10
12 + 8 = ?;19;20;21;22;B;Penjumlahan sederhana
25 - 9 = ?;15;16;17;18;B;Pengurangan sederhana
6 x 4 = ?;22;23;24;25;C;Perkalian dasar
18 + 7 = ?;24;25;26;27;B;Penjumlahan dua angka
30 - 12 = ?;17;18;19;20;B;Pengurangan
9 x 3 = ?;26;27;28;29;B;Perkalian
15 + 9 = ?;23;24;25;26;B;Penjumlahan
40 √∑ 5 = ?;7;8;9;10;B;Pembagian dasar
11 x 3 = ?;32;33;34;35;B;Perkalian
27 - 8 = ?;18;19;20;21;B;Pengurangan
7 x 6 = ?;40;41;42;43;C;Perkalian
14 + 11 = ?;24;25;26;27;B;Penjumlahan`;
          filename = 'template_soal_tangga.csv';
        } else if (type === 'snake') {
          template = `Pertanyaan;Pilihan A;Pilihan B;Pilihan C;Pilihan D;Jawaban Benar (A/B/C/D);Clue
Berapa 9 + 6?;14;15;16;17;B;Penjumlahan dua angka
13 x 2 = ?;25;26;27;28;B;Perkalian dengan 2
20 - 7 = ?;12;13;14;15;B;Pengurangan
8 x 5 = ?;35;40;45;50;B;Perkalian dasar
17 + 8 = ?;24;25;26;27;B;Penjumlahan
35 √∑ 5 = ?;6;7;8;9;B;Pembagian
12 x 3 = ?;34;35;36;37;C;Perkalian
25 - 9 = ?;15;16;17;18;B;Pengurangan
11 + 14 = ?;24;25;26;27;B;Penjumlahan
6 x 7 = ?;40;41;42;43;C;Perkalian
30 - 13 = ?;16;17;18;19;B;Pengurangan
9 x 4 = ?;35;36;37;38;B;Perkalian
18 + 12 = ?;29;30;31;32;B;Penjumlahan
42 √∑ 6 = ?;6;7;8;9;B;Pembagian
15 x 2 = ?;28;29;30;31;C;Perkalian`;
          filename = 'template_soal_ular.csv';
        }
        
        try {
          const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Error downloading template:', error);
          alert('Error downloading template');
        }
      };

      const parseCSV = (text, type) => {
        const lines = text.split('\n').slice(1);
        return lines
          .filter(line => line.trim())
          .map((line, idx) => {
            const parts = line.split(';').reduce((acc, part) => {
              if (part.startsWith('"') && !part.endsWith('"')) {
                acc.inProgress = part;
              } else if (acc.inProgress) {
                acc.inProgress += ';' + part;
                if (part.endsWith('"')) {
                  acc.parts.push(acc.inProgress.replace(/"/g, ''));
                  acc.inProgress = null;
                }
              } else {
                acc.parts.push(part.replace(/"/g, '').trim());
              }
              return acc;
            }, { parts: [], inProgress: null }).parts;

            const baseQuestion = {
              id: idx + 1,
              question: parts[0] || 'Pertanyaan tidak tersedia',
              options: [
                parts[1] || 'Option A',
                parts[2] || 'Option B',
                parts[3] || 'Option C',
                parts[4] || 'Option D'
              ],
              correctAnswer: (parts[5] || 'A').trim().toUpperCase(),
              clue: parts[6] || 'Tidak ada clue',
              used: false
            };

            if (type === 'main') {
              return {
                ...baseQuestion,
                reward: Math.max(1, parseInt(parts[7]) || 5),
                penalty: Math.max(1, parseInt(parts[8]) || 3),
                duration: Math.max(5, parseInt(parts[9]) || 15),
              };
            } else {
              return baseQuestion;
            }
          })
          .filter(q => q.question && q.question !== 'Pertanyaan tidak tersedia');
      };

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        setLoading(true);
        const reader = new FileReader();
        
        reader.onload = (event) => {
          try {
            const text = event.target.result;
            const parsedQuestions = parseCSV(text, type);
            
            if (type === 'main') {
              setQuestions(parsedQuestions);
              setUploadedFiles(prev => ({ ...prev, main: true }));
              alert(`${parsedQuestions.length} soal utama berhasil dimuat!`);
            } else if (type === 'ladder') {
              setLadderQuestions(parsedQuestions);
              setUploadedFiles(prev => ({ ...prev, ladder: true }));
              alert(`${parsedQuestions.length} soal tangga berhasil dimuat!`);
            } else if (type === 'snake') {
              setSnakeQuestions(parsedQuestions);
              setUploadedFiles(prev => ({ ...prev, snake: true }));
              alert(`${parsedQuestions.length} soal ular berhasil dimuat!`);
            }
          } catch (error) {
            console.error('Error parsing CSV:', error);
            alert('Error parsing file CSV. Pastikan format file benar.');
          } finally {
            setLoading(false);
          }
        };
        
        reader.onerror = () => {
          alert('Error reading file');
          setLoading(false);
        };
        
        reader.readAsText(file);
        // Reset input file
        e.target.value = '';
      };

      const startGame = () => {
        if (questions.length < 3) {
          alert('Minimal 3 soal utama diperlukan untuk memulai game!');
          return;
        }
        setGameState('playing');
        setGameTimer(0);
        setShowWinnerPopup(false);
        setWinner(null);
        setWinnerReason('');
        setSpecialQuestionAnswered(false);
        pickQuestion();
      };

      const pickQuestion = () => {
        const availableQuestions = questions.filter(q => !q.used);
        if (availableQuestions.length === 0) {
          endGameByQuestions();
          return;
        }
        
        const randomQ = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
        setCurrentQuestion({ ...randomQ });
        setQuestionTimer(randomQ.duration);
        setShowAnswer(false);
        setShowClue(false);
        setSpecialQuestionAnswered(false);
      };

      const pickLadderQuestion = () => {
        const availableQuestions = ladderQuestions.filter(q => !q.used);
        if (availableQuestions.length === 0) {
          // Reset jika semua soal sudah digunakan
          setLadderQuestions(prev => prev.map(q => ({ ...q, used: false })));
          return pickLadderQuestion();
        }
        
        const randomQ = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
        setLadderQuestions(prev => prev.map(q => 
          q.id === randomQ.id ? { ...q, used: true } : q
        ));
        return randomQ;
      };

      const pickSnakeQuestion = () => {
        const availableQuestions = snakeQuestions.filter(q => !q.used);
        if (availableQuestions.length === 0) {
          // Reset jika semua soal sudah digunakan
          setSnakeQuestions(prev => prev.map(q => ({ ...q, used: false })));
          return pickSnakeQuestion();
        }
        
        const randomQ = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
        setSnakeQuestions(prev => prev.map(q => 
          q.id === randomQ.id ? { ...q, used: true } : q
        ));
        return randomQ;
      };

      const useHelp = (helpType) => {
        const team = questionThrown ? (currentTeam === 'A' ? 'B' : 'A') : currentTeam;
        
        if (helps[team][helpType] <= 0) {
          alert('Bantuan ini sudah habis!');
          return;
        }

        setHelps(prev => ({
          ...prev,
          [team]: {
            ...prev[team],
            [helpType]: prev[team][helpType] - 1
          }
        }));

        switch(helpType) {
          case 'throwQuestion':
            setQuestionThrown(true);
            alert(`Soal dilempar ke Kelompok ${currentTeam === 'A' ? 'B' : 'A'}!`);
            break;
          case 'clue':
            setShowClue(true);
            break;
          case 'shield':
            setShieldActive(true);
            alert('Shield aktif! Tidak akan mundur atau turun ular pada giliran ini.');
            break;
          case 'changeQuestion':
            pickQuestion();
            alert('Soal diganti!');
            break;
          case 'doubleMove':
            setDoubleMoveActive(true);
            alert('Double Move aktif! Langkah akan dilipatgandakan jika benar.');
            break;
          default:
            break;
        }
        
        setSelectedHelp(helpType);
      };

      const handleAnswer = (selectedOption, question = null, isSpecialQuestion = false) => {
        const targetQuestion = question || currentQuestion;
        if (!targetQuestion) return;
        
        if (isSpecialQuestion) {
          // Untuk soal khusus (tangga/ular), gunakan state terpisah
          setSpecialQuestionAnswered(true);
        } else {
          // Untuk soal utama
          if (showAnswer) return;
          setShowAnswer(true);
          if (questionTimerRef.current) {
            clearInterval(questionTimerRef.current);
          }
        }
        
        const isCorrect = selectedOption === targetQuestion.correctAnswer;
        const answeringTeam = questionThrown ? (currentTeam === 'A' ? 'B' : 'A') : currentTeam;
        
        setTimeout(() => {
          if (isSpecialQuestion) {
            if (isCorrect) {
              alert('Benar!');
              if (ladderBonusQuestion) {
                setPositions(prev => ({
                  ...prev,
                  [ladderBonusQuestion.team]: ladderBonusQuestion.to
                }));
                setLadderBonusQuestion(null);
              } else if (snakeSaveQuestion) {
                // Tetap di posisi saat ini (selamat dari ular)
                setSnakeSaveQuestion(null);
              }
            } else {
              alert('Salah!');
              if (snakeSaveQuestion) {
                setPositions(prev => ({
                  ...prev,
                  [snakeSaveQuestion.team]: snakeSaveQuestion.to
                }));
                setSnakeSaveQuestion(null);
              } else {
                setLadderBonusQuestion(null);
              }
            }
            setSpecialQuestionAnswered(false);
            nextTurn();
          } else {
            if (isCorrect) {
              let steps = targetQuestion.reward;
              if (doubleMoveActive && !questionThrown) {
                steps *= 2;
                alert(`Benar! Double Move aktif, maju ${steps} langkah!`);
                setDoubleMoveActive(false);
              } else {
                alert(`Benar! Maju ${steps} langkah.`);
              }
              moveToken(answeringTeam, steps, false);
            } else {
              const penalty = shieldActive && !questionThrown ? 0 : targetQuestion.penalty;
              if (penalty > 0) {
                alert(`Salah! Mundur ${penalty} langkah.`);
                moveToken(answeringTeam, -penalty, true);
              } else if (shieldActive) {
                alert('Salah! Tapi Shield melindungi, tidak mundur.');
                setShieldActive(false);
                nextTurn();
              }
            }
            
            // Tandai soal sebagai digunakan
            setQuestions(prev => prev.map(q => 
              q.id === targetQuestion.id ? { ...q, used: true } : q
            ));
          }
        }, 2000);
      };

      const moveToken = (team, steps, isBackward) => {
        setPositions(prev => {
          let newPos = prev[team] + steps;
          
          if (newPos < 1) newPos = 1;
          if (newPos > 100) newPos = 100;
          
          const newPositions = { ...prev, [team]: newPos };
          
          if (newPos >= 100) {
            endGameByPosition(team);
            return newPositions;
          }
          
          if (!isBackward && ladders[newPos]) {
            setTimeout(() => {
              const ladderQuestion = pickLadderQuestion();
              setLadderBonusQuestion({
                team,
                from: newPos,
                to: ladders[newPos],
                question: ladderQuestion
              });
            }, 500);
          }
          else if (snakes[newPos]) {
            if (shieldActive && team === (questionThrown ? (currentTeam === 'A' ? 'B' : 'A') : currentTeam)) {
              alert('Shield melindungi dari ular!');
              setShieldActive(false);
              setTimeout(nextTurn, 1000);
            } else {
              setTimeout(() => {
                const snakeQuestion = pickSnakeQuestion();
                setSnakeSaveQuestion({
                  team,
                  from: newPos,
                  to: snakes[newPos],
                  question: snakeQuestion
                });
              }, 500);
            }
          } else {
            setTimeout(nextTurn, 1000);
          }
          
          return newPositions;
        });
      };

      const handleLadderBonus = (selectedOption) => {
        if (specialQuestionAnswered) return;
        handleAnswer(selectedOption, ladderBonusQuestion.question, true);
      };

      const handleSnakeSave = (selectedOption) => {
        if (specialQuestionAnswered) return;
        handleAnswer(selectedOption, snakeSaveQuestion.question, true);
      };

      const nextTurn = () => {
        setCurrentTeam(prev => prev === 'A' ? 'B' : 'A');
        setCurrentQuestion(null);
        setSelectedHelp(null);
        setShieldActive(false);
        setDoubleMoveActive(false);
        setQuestionThrown(false);
        setShowClue(false);
        setShowAnswer(false);
        setSpecialQuestionAnswered(false);
        setTimeout(pickQuestion, 500);
      };

      const resetGame = () => {
        if (gameTimerRef.current) clearInterval(gameTimerRef.current);
        if (questionTimerRef.current) clearInterval(questionTimerRef.current);
        
        setGameState('setup');
        setPositions({ A: 1, B: 1 });
        setHelps({
          A: { throwQuestion: 2, clue: 1, shield: 1, changeQuestion: 1, doubleMove: 2 },
          B: { throwQuestion: 2, clue: 1, shield: 1, changeQuestion: 1, doubleMove: 2 }
        });
        setCurrentTeam('A');
        setGameTimer(0);
        setWinner(null);
        setShowWinnerPopup(false);
        setWinnerReason('');
        setQuestions(prev => prev.map(q => ({ ...q, used: false })));
        setLadderQuestions(prev => prev.map(q => ({ ...q, used: false })));
        setSnakeQuestions(prev => prev.map(q => ({ ...q, used: false })));
        setCurrentQuestion(null);
        setShowAnswer(false);
        setSpecialQuestionAnswered(false);
      };

      const closeWinnerPopup = () => {
        setShowWinnerPopup(false);
        setGameState('finished');
      };

      const renderBoard = () => {
        const cells = [];
        for (let row = 9; row >= 0; row--) {
          for (let col = 0; col < 10; col++) {
            const num = row % 2 === 1 
              ? row * 10 + (10 - col)
              : row * 10 + col + 1;
            
            const isSnakeHead = snakes[num];
            const isLadderBottom = ladders[num];
            const hasTeamA = positions.A === num;
            const hasTeamB = positions.B === num;
            
            cells.push(
              <div
                key={num}
                className={`
                  board-cell border border-gray-300 flex items-center justify-center text-xs font-bold
                  ${isSnakeHead ? 'bg-red-200' : isLadderBottom ? 'bg-green-200' : 'bg-white'}
                `}
              >
                <span className="absolute top-0 left-0 text-[8px] text-gray-500 p-1">{num}</span>
                
                {isSnakeHead && <ChevronDownIcon />}
                {isLadderBottom && <ChevronUpIcon />}
                
                <div className="flex gap-0.5 mt-3">
                  {hasTeamA && (
                    <div className={`w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 border-2 border-white shadow-lg token-bounce flex items-center justify-center text-white text-[10px] font-bold`}>
                      A
                    </div>
                  )}
                  {hasTeamB && (
                    <div className={`w-4 h-4 rounded-full bg-gradient-to-br from-red-400 to-red-600 border-2 border-white shadow-lg token-bounce flex items-center justify-center text-white text-[10px] font-bold`}>
                      B
                    </div>
                  )}
                </div>
              </div>
            );
          }
        }
        return cells;
      };

      const WinnerPopup = () => {
        if (!showWinnerPopup) return null;

        return (
          <div className="popup-overlay">
            <div className="popup-content">
              <div className="text-6xl mb-4">üèÜ</div>
              <h2 className="text-3xl font-bold mb-4 text-yellow-600">
                {winner === 'Seri' ? 'Permainan Seri!' : `Kelompok ${winner} Menang!`}
              </h2>
              <p className="text-lg text-gray-700 mb-2">
                {winnerReason}
              </p>
              <p className="text-md text-gray-600 mb-6">
                Waktu bermain: {formatTime(gameTimer)}
              </p>
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div className="text-center">
                  <p className="font-bold text-blue-600">Kelompok A</p>
                  <p className="text-2xl">Posisi: {positions.A}</p>
                </div>
                <div className="text-center">
                  <p className="font-bold text-red-600">Kelompok B</p>
                  <p className="text-2xl">Posisi: {positions.B}</p>
                </div>
              </div>
              <button
                onClick={closeWinnerPopup}
                className="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition text-lg font-bold w-full"
              >
                Tutup & Lihat Hasil
              </button>
            </div>
          </div>
        );
      };

      const clearAllData = () => {
        sessionStorage.clear();
        setQuestions([]);
        setLadderQuestions([]);
        setSnakeQuestions([]);
        setUploadedFiles({ main: false, ladder: false, snake: false });
        alert('Semua data telah direset!');
      };

      if (gameState === 'setup') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
            <div className="max-w-4xl mx-auto">
              <h1 className="text-3xl md:text-4xl font-bold text-center mb-2 text-purple-800">
                üéÆ EduLadder Battle by Ridwan Na'im
              </h1>
              <p className="text-center text-gray-600 mb-6">Game Edukasi untuk 2 Kelompok</p>
              
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 className="text-xl md:text-2xl font-bold mb-4 text-gray-800">üìù Import Soal</h2>
                
                <div className="space-y-6">
                  {/* Soal Utama */}
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <h3 className="font-bold text-lg mb-3 text-blue-600">üéØ Soal Utama</h3>
                    <div className="space-y-3">
                      <button
                        onClick={() => downloadTemplate('main')}
                        className="w-full flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"
                      >
                        <DownloadIcon />
                        Download Template Soal Utama
                      </button>
                      
                      <label className="w-full flex items-center justify-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition cursor-pointer">
                        <UploadIcon />
                        {loading ? 'Memuat...' : 'Upload Soal Utama (CSV)'}
                        <input
                          type="file"
                          accept=".csv"
                          onChange={(e) => handleFileUpload(e, 'main')}
                          className="hidden"
                          disabled={loading}
                        />
                      </label>
                      
                      {uploadedFiles.main && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                          <p className="text-green-800 font-semibold">
                            ‚úÖ {questions.length} soal utama telah dimuat
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Soal Tangga */}
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <h3 className="font-bold text-lg mb-3 text-green-600">ü™ú Soal Tangga Bonus</h3>
                    <div className="space-y-3">
                      <button
                        onClick={() => downloadTemplate('ladder')}
                        className="w-full flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"
                      >
                        <DownloadIcon />
                        Download Template Soal Tangga
                      </button>
                      
                      <label className="w-full flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition cursor-pointer">
                        <UploadIcon />
                        {loading ? 'Memuat...' : 'Upload Soal Tangga (CSV)'}
                        <input
                          type="file"
                          accept=".csv"
                          onChange={(e) => handleFileUpload(e, 'ladder')}
                          className="hidden"
                          disabled={loading}
                        />
                      </label>
                      
                      {uploadedFiles.ladder && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                          <p className="text-green-800 font-semibold">
                            ‚úÖ {ladderQuestions.length} soal tangga telah dimuat
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Soal Ular */}
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <h3 className="font-bold text-lg mb-3 text-red-600">üêç Soal Penyelamat Ular</h3>
                    <div className="space-y-3">
                      <button
                        onClick={() => downloadTemplate('snake')}
                        className="w-full flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition"
                      >
                        <DownloadIcon />
                        Download Template Soal Ular
                      </button>
                      
                      <label className="w-full flex items-center justify-center gap-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition cursor-pointer">
                        <UploadIcon />
                        {loading ? 'Memuat...' : 'Upload Soal Ular (CSV)'}
                        <input
                          type="file"
                          accept=".csv"
                          onChange={(e) => handleFileUpload(e, 'snake')}
                          className="hidden"
                          disabled={loading}
                        />
                      </label>
                      
                      {uploadedFiles.snake && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                          <p className="text-green-800 font-semibold">
                            ‚úÖ {snakeQuestions.length} soal ular telah dimuat
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  <button
                    onClick={clearAllData}
                    className="w-full flex items-center justify-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition"
                  >
                    üóëÔ∏è Hapus Semua Data
                  </button>
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl md:text-2xl font-bold mb-4 text-gray-800">üìã Aturan Game</h2>
                <ul className="space-y-2 text-gray-700 text-sm md:text-base">
                  <li>üéØ Tujuan: Mencapai kotak 100 terlebih dahulu</li>
                  <li>‚ùì Jawab soal dengan benar untuk maju, salah untuk mundur</li>
                  <li>ü™ú Tangga hijau: naik ke atas (dengan soal bonus)</li>
                  <li>üêç Ular merah: turun ke bawah (bisa diselamatkan dengan soal)</li>
                  <li>üõ°Ô∏è 5 jenis bantuan per kelompok</li>
                  <li>‚è±Ô∏è Setiap soal memiliki batas waktu</li>
                  <li>üèÜ Game berakhir ketika ada yang mencapai 100 atau soal habis</li>
                </ul>
                
                <button
                  onClick={startGame}
                  disabled={questions.length < 3 || loading}
                  className="w-full mt-6 flex items-center justify-center gap-2 bg-purple-600 text-white px-6 py-4 rounded-lg hover:bg-purple-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed text-lg font-bold"
                >
                  <PlayIcon />
                  Mulai Permainan
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-2">
          <WinnerPopup />
          
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-3 mb-3 flex items-center justify-between">
              <div>
                <h1 className="text-xl md:text-2xl font-bold text-purple-800">üéÆ Ular Tangga Pembelajaran</h1>
                <p className="text-sm text-gray-600">Giliran: Kelompok {currentTeam}</p>
              </div>
              <div className="text-right">
                <div className="flex items-center gap-2 text-lg font-mono">
                  <TimerIcon />
                  <span className="font-bold">{formatTime(gameTimer)}</span>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-3">
              <div className="lg:col-span-2">
                <div className="bg-white rounded-xl shadow-lg p-3">
                  <div className="grid grid-cols-10 gap-0 border-2 border-gray-400 mx-auto" style={{maxWidth: 'fit-content'}}>
                    {renderBoard()}
                  </div>
                  
                  <div className="mt-3 grid grid-cols-2 gap-3">
                    <div className={`p-3 rounded-lg ${currentTeam === 'A' ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50'}`}>
                      <div className="flex items-center gap-2 mb-1">
                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-blue-400 to-blue-600"></div>
                        <span className="font-bold">Kelompok A</span>
                      </div>
                      <p className="text-lg font-bold">Posisi: {positions.A}</p>
                    </div>
                    
                    <div className={`p-3 rounded-lg ${currentTeam === 'B' ? 'bg-red-100 border-2 border-red-500' : 'bg-gray-50'}`}>
                      <div className="flex items-center gap-2 mb-1">
                        <div className="w-4 h-4 rounded-full bg-gradient-to-br from-red-400 to-red-600"></div>
                        <span className="font-bold">Kelompok B</span>
                      </div>
                      <p className="text-lg font-bold">Posisi: {positions.B}</p>
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-3">
                {!ladderBonusQuestion && !snakeSaveQuestion && currentQuestion && !showAnswer && (
                  <div className="bg-white rounded-xl shadow-lg p-3">
                    <h3 className="font-bold text-md mb-2">üõ†Ô∏è Bantuan Kelompok {currentTeam}</h3>
                    <div className="space-y-1">
                      {['throwQuestion', 'clue', 'shield', 'changeQuestion', 'doubleMove'].map((helpType) => (
                        <button
                          key={helpType}
                          onClick={() => useHelp(helpType)}
                          disabled={helps[currentTeam][helpType] === 0 || 
                                   (helpType === 'throwQuestion' && questionThrown) ||
                                   (helpType === 'clue' && showClue) ||
                                   (helpType === 'shield' && shieldActive) ||
                                   (helpType === 'doubleMove' && doubleMoveActive)}
                          className="w-full flex items-center justify-between p-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-xs"
                        >
                          <span>
                            {helpType === 'throwQuestion' && 'üéØ Lempar Soal'}
                            {helpType === 'clue' && 'üí° Clue'}
                            {helpType === 'shield' && 'üõ°Ô∏è Shield'}
                            {helpType === 'changeQuestion' && 'üîÑ Ganti Soal'}
                            {helpType === 'doubleMove' && '‚ö° Double Move'}
                          </span>
                          <span className="font-bold">{helps[currentTeam][helpType]}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {currentQuestion && !ladderBonusQuestion && !snakeSaveQuestion && (
                  <div className="bg-white rounded-xl shadow-lg p-3">
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="font-bold text-md">
                        {questionThrown ? `‚ùì Soal untuk Kelompok ${currentTeam === 'A' ? 'B' : 'A'}` : `‚ùì Soal Kelompok ${currentTeam}`}
                      </h3>
                      <div className={`text-xl font-bold ${questionTimer <= 5 ? 'text-red-600 animate-pulse' : 'text-blue-600'}`}>
                        {questionTimer}s
                      </div>
                    </div>
                    
                    <div className="mb-3 p-2 bg-gray-50 rounded-lg">
                      <p className="font-semibold text-sm">{currentQuestion.question}</p>
                      {showClue && (
                        <p className="text-xs text-purple-600 mt-1">üí° Clue: {currentQuestion.clue}</p>
                      )}
                    </div>
                    
                    <div className="space-y-1">
                      {currentQuestion.options.map((option, idx) => {
                        const optionLetter = String.fromCharCode(65 + idx);
                        const isCorrect = optionLetter === currentQuestion.correctAnswer;
                        const buttonClass = showAnswer
                          ? isCorrect
                            ? 'bg-green-200 border-green-500'
                            : 'bg-red-100 border-red-300'
                          : 'bg-gray-50 hover:bg-blue-50 border-gray-300';
                        
                        return (
                          <button
                            key={idx}
                            onClick={() => !showAnswer && handleAnswer(optionLetter)}
                            disabled={showAnswer}
                            className={`w-full p-2 rounded border text-left transition ${buttonClass} disabled:cursor-not-allowed text-xs`}
                          >
                            <span className="font-bold">{optionLetter}.</span> {option}
                            {showAnswer && isCorrect && ' ‚úì'}
                          </button>
                        );
                      })}
                    </div>
                    
                    <div className="mt-2 flex justify-between text-xs text-gray-600">
                      <span>‚úÖ +{currentQuestion.reward}</span>
                      <span>‚ùå -{currentQuestion.penalty}</span>
                    </div>
                  </div>
                )}

                {ladderBonusQuestion && (
                  <div className="bg-white rounded-xl shadow-lg p-3 border-2 border-green-400">
                    <h3 className="font-bold text-md mb-2 text-green-700">
                      ü™ú Soal Tangga Bonus!
                    </h3>
                    <p className="mb-2 text-sm">Kotak {ladderBonusQuestion.from} ‚Üí {ladderBonusQuestion.to}</p>
                    <p className="font-semibold mb-2 text-sm">{ladderBonusQuestion.question.question}</p>
                    {ladderBonusQuestion.question.clue && (
                      <p className="text-xs text-purple-600 mb-2">üí° Clue: {ladderBonusQuestion.question.clue}</p>
                    )}
                    <div className="space-y-1">
                      {ladderBonusQuestion.question.options.map((option, idx) => {
                        const optionLetter = String.fromCharCode(65 + idx);
                        const isCorrect = optionLetter === ladderBonusQuestion.question.correctAnswer;
                        const buttonClass = specialQuestionAnswered
                          ? isCorrect
                            ? 'bg-green-200 border-green-500'
                            : 'bg-red-100 border-red-300'
                          : 'bg-gray-50 hover:bg-green-100 border-gray-300';
                        
                        return (
                          <button
                            key={idx}
                            onClick={() => handleLadderBonus(optionLetter)}
                            disabled={specialQuestionAnswered}
                            className={`w-full p-2 rounded border text-left transition ${buttonClass} disabled:cursor-not-allowed text-xs`}
                          >
                            <span className="font-bold">{optionLetter}.</span> {option}
                            {specialQuestionAnswered && isCorrect && ' ‚úì'}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}

                {snakeSaveQuestion && (
                  <div className="bg-white rounded-xl shadow-lg p-3 border-2 border-red-400">
                    <h3 className="font-bold text-md mb-2 text-red-700">
                      üêç Soal Penyelamat Ular!
                    </h3>
                    <p className="mb-2 text-sm">Kotak {snakeSaveQuestion.from} ‚Üí {snakeSaveQuestion.to}</p>
                    <p className="font-semibold mb-2 text-sm">{snakeSaveQuestion.question.question}</p>
                    {snakeSaveQuestion.question.clue && (
                      <p className="text-xs text-purple-600 mb-2">üí° Clue: {snakeSaveQuestion.question.clue}</p>
                    )}
                    <div className="space-y-1">
                      {snakeSaveQuestion.question.options.map((option, idx) => {
                        const optionLetter = String.fromCharCode(65 + idx);
                        const isCorrect = optionLetter === snakeSaveQuestion.question.correctAnswer;
                        const buttonClass = specialQuestionAnswered
                          ? isCorrect
                            ? 'bg-green-200 border-green-500'
                            : 'bg-red-100 border-red-300'
                          : 'bg-gray-50 hover:bg-green-100 border-gray-300';
                        
                        return (
                          <button
                            key={idx}
                            onClick={() => handleSnakeSave(optionLetter)}
                            disabled={specialQuestionAnswered}
                            className={`w-full p-2 rounded border text-left transition ${buttonClass} disabled:cursor-not-allowed text-xs`}
                          >
                            <span className="font-bold">{optionLetter}.</span> {option}
                            {specialQuestionAnswered && isCorrect && ' ‚úì'}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}

                {gameState === 'finished' && !showWinnerPopup && (
                  <div className="bg-white rounded-xl shadow-lg p-4 text-center">
                    <h3 className="text-xl font-bold mb-2">Permainan Selesai</h3>
                    <p className="mb-4">Terima kasih telah bermain!</p>
                    <button
                      onClick={resetGame}
                      className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition"
                    >
                      Main Lagi
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Render aplikasi
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SnakesLaddersGame />);
  </script>
</body>
</html>